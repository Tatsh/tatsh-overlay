From 9849547ca329cad141b06c187b6834bd3cb46434 Mon Sep 17 00:00:00 2001
From: Andrew Udvare <audvare@gmail.com>
Date: Wed, 6 Oct 2021 02:35:51 -0400
Subject: [PATCH 02/11] Make running tests configurable

---
 configure         |  5 +++++
 meson.build       | 11 +++++++----
 meson_options.txt |  2 ++
 3 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/configure b/configure
index 92ba54b375..6369318177 100755
--- a/configure
+++ b/configure
@@ -769,6 +769,10 @@ for opt do
   ;;
   --rust-target-triple=*) rust_target_triple="$optarg"
   ;;
+  --enable-tests) meson_option_add -Drun_tests=true
+  ;;
+  --disable-tests) meson_option_add -Drun_tests=false
+  ;;
   --gdb=*) gdb_bin="$optarg"
   ;;
   --enable-rust) rust=enabled
@@ -910,6 +914,7 @@ Advanced options (experts only):
   --cpu=CPU                Build for host CPU [$cpu]
   --disable-containers     don't use containers for cross-building
   --container-engine=TYPE  which container engine to use [$container_engine]
+  --disable-tests          disable tests
   --gdb=GDB-path           gdb to use for gdbstub tests [$gdb_bin]
 EOF
   meson_options_help
diff --git a/meson.build b/meson.build
index 24e14547a7..06dad15756 100644
--- a/meson.build
+++ b/meson.build
@@ -4077,8 +4077,10 @@ subdir('bsd-user')
 subdir('linux-user')
 
 # needed for fuzzing binaries
-subdir('tests/qtest/libqos')
-subdir('tests/qtest/fuzz')
+if get_option('run_tests')
+	subdir('tests/qtest/libqos')
+	subdir('tests/qtest/fuzz')
+endif
 
 # accel modules
 target_modules += { 'accel' : { 'qtest': qtest_module_ss }}
@@ -4801,7 +4803,7 @@ subdir('pc-bios')
 subdir('docs')
 # Tests are disabled on emscripten because they rely on host features that aren't
 # supported by emscripten (e.g. fork and unix socket).
-if host_os != 'emscripten'
+if host_os != 'emscripten' or get_option('run_tests')
   subdir('tests')
 endif
 if gtk.found()
@@ -4894,7 +4896,8 @@ summary_info += {'system-mode emulation': have_system}
 summary_info += {'user-mode emulation': have_user}
 summary_info += {'block layer':       have_block}
 summary_info += {'Install blobs':     get_option('install_blobs')}
-summary_info += {'module support':    enable_modules}
+summary_info += {'Run tests':         get_option('run_tests')}
+summary_info += {'module support':    config_host.has_key('CONFIG_MODULES')}
 if enable_modules
   summary_info += {'alternative module path': get_option('module_upgrades')}
 endif
diff --git a/meson_options.txt b/meson_options.txt
index fc7e57c8a7..b48bf7825b 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -67,6 +67,8 @@ option('tools', type : 'feature', value : 'auto',
        description: 'build support utilities that come with QEMU')
 option('qga_vss', type : 'feature', value: 'auto',
        description: 'build QGA VSS support (broken with MinGW)')
+option('run_tests', type : 'boolean', value : false,
+       description : 'run validation tests' )
 
 option('malloc_trim', type : 'feature', value : 'auto',
        description: 'enable libc malloc_trim() for memory optimization')
-- 
2.52.0

